define(["core/ajax","core/tree","core/templates","jquery"],(e,t,i,n)=>{let s=function(e,t,i,n){this.id=e,this.settingId=t,this.label=i,this.description=n,this.parent=null,this.displayed=!1,this.checked=!0,this.level=1,this.children=[]};s.prototype.hasChildren=function(){return this.children.length>0},s.prototype.isEmpty=function(){return"category"===this.settingId&&!this.hasChildren()};let d=function(e){this.view=null,this.nodes=[],this.accessibleview=null,this.rootNode=document.getElementById(e)};return d.prototype.init=function(e,i,n,d,o){let l=e.length;this.rootNode.innerHTML="";let h=[];for(let t=0;t<l;t++){let o=new s(i[t],e[t],decodeURIComponent(n[t]),decodeURIComponent(d[t]));this.nodes[o.id]=o}for(let e=0;e<l;e++)"root"===o[e]?this.nodes[i[e]].parent=null:(this.nodes[i[e]].parent=this.nodes[o[e]],this.nodes[o[e]].children.push(this.nodes[i[e]]));for(var r in this.nodes)this.nodes.hasOwnProperty(r)&&null===this.nodes[r].parent&&h.push(this.display(r));Promise.all(h).finally(e=>{this.accessibleview=new t("#"+this.rootNode.getAttribute("id"))})},d.prototype.applyEvent=function(e){let t=this.nodes[e];if(t.displayed){let i=document.getElementById(e);i.addEventListener("focus",()=>{if(t.hasChildren()){let i=[];t.children.forEach(e=>{i.push(this.display(e.id))}),Promise.all(i).finally(t=>{this.accessibleview.initialiseNodes(n("#"+e))})}}),document.getElementById(e+"_checkbox").addEventListener("click",i=>{i.stopPropagation(),i.preventDefault(),this.setChecked(e,!t.checked)}),i.addEventListener("keydown",i=>{"Enter"===i.key&&(i.stopPropagation(),i.preventDefault(),this.setChecked(e,!t.checked))})}},d.prototype.display=function(e){return new Promise((t,n)=>{let s=this.nodes[e];if(s.displayed||s.isEmpty())t(!0);else{let d=null;null===s.parent?d=this.rootNode:(d=document.getElementById(s.parent.id).getElementsByTagName("ul")[0],this.nodes[e].level=this.nodes[s.parent.id].level+1);let o="";s.hasChildren()&&(o="has-children");let l="checkbox-unchecked";s.checked&&(l="checkbox-checked");let h={id:s.id,level:s.level,label:s.label,has_children:o,checked:l};i.render("tool_admin_presets/tree_node",h).then(i=>{d.insertAdjacentHTML("beforeend",i),this.nodes[e].displayed=!0,this.applyEvent(e),t(!0)}).fail(function(e){n(!1),console.error(e)})}})},d.prototype.setChecked=function(e,t){let i=this.nodes[e];if(this.nodes[e].checked=t,i.displayed){let i=document.getElementById(e+"_checkbox");t?i.setAttribute("class","checkbox-checked"):i.setAttribute("class","checkbox-unchecked")}i.hasChildren()&&i.children.forEach(e=>{this.setChecked(e.id,t)})},d.prototype.submit=function(e){document.getElementById(e).addEventListener("click",()=>{let t=document.getElementById(e).parentNode;for(var i in t.getElementsByTagName("input").forEach(e=>{"hidden"===e.getAttribute("type")&&e.remove()}),this.nodes)if(this.nodes.hasOwnProperty(i)){let e=this.nodes[i];if("category"!==e.settingId&&"page"!==e.settingId&&e.checked){let i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name",e.settingId),i.setAttribute("value","1"),t.appendChild(i)}}})},{init:(t,i)=>{e.call([{methodname:"tool_admin_presets_get_settings",args:{action:t,id:i}}],!0,!0)[0].done(e=>{let t=new d("settings_tree_div");t.init(e.ids,e.nodes,e.labels,e.descriptions,e.parents),t.submit("id_admin_presets_submit")})}}});
